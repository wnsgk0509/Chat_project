unit RegisterUser;
{
0-1. À¯Àú µî·ÏÈ­¸é
ÅØ½ºÆ® ÀÔ·Â Ä­( ÀÌ¸§ ¼³Á¤) + Àü¼Û ¹öÆ°
(¿¹¿Ü Ã³¸® = °ø¹é, Áßº¹, ½ºÆäÀÌ½º¹Ù Á¦°Å)

µî·Ï¿Ï·á½Ã -> µî·Ï ¿Ï·á½Ã ÆË¾÷(success) ÈÄ ¸ŞÀÎÈ­¸é ÀüÈ¯
}

interface

uses
   Winapi.Windows, Winapi.Messages, System.SysUtils, System.Variants, System.Classes, Vcl.Graphics,
   Vcl.Controls, Vcl.Forms, Vcl.Dialogs, Vcl.StdCtrls,RegularExpressions, IdTCPClient, Connect, IdIOHandler, IdGlobal,
   Main;

type
   TRegisterUserForm = class(TForm)
      editName: TEdit;
      btnRegist: TButton;
      StaticText1: TStaticText;

      procedure FormCreate(Sender: TObject);
      procedure btnRegistClick(Sender: TObject);
      procedure SendChatStringDirectly;
   private
    { Private declarations }
   public
    { Public declarations }
   end;

var
   RegisterUserForm: TRegisterUserForm;

implementation

{$R *.dfm}

//Æû ÃÊ±âÈ­
procedure TRegisterUserForm.FormCreate(Sender: TObject);
begin
   editName.Text := '';
   editName.MaxLength := 8;
end;

//µî·Ï¹öÆ° Å¬¸¯
{
(¿¹¿Ü Ã³¸® = °ø¹é, Áßº¹,½ºÆäÀÌ½º¹Ù Á¦ÇÑ)
µî·Ï¿Ï·á½Ã -> µî·Ï ¿Ï·á½Ã ÆË¾÷(success) ÈÄ ¸ŞÀÎÈ­¸é ÀüÈ¯

1.°ø¹é°Ë»ç: Pos(°ø¹é) ÀÖÀ»½Ã ¹İÈ¯
2.Æ¯¼ö¹®ÀÚ:°¡-ÆRa-Z,0-9 ¸¦ Á¦¿ÜÇÑ ¹®ÀÚ ÀÔ·Â½Ã ¹İÈ¯
3.Áßº¹°Ë»ç: ¼­¹ö¿¡ ÀÖ´Â À¯Àú ÀÌ¸§À» ºñ±³ÇØ¼­ µ¿ÀÏÇÑ°Ô ¾øÀ¸¸é µî·Ï
}
procedure TRegisterUserForm.btnRegistClick(Sender: TObject);
var
   UserNameInput: string;   // »ç ¿ëÀÚ ÀÔ·Â ¿øº» (°ø¹é ¹× Æ¯¼ö¹®ÀÚ Æ÷ÇÔ °¡´É¼º)

begin
   UserNameInput := editName.Text;

   // === 1. °ø¹é¸¸ ÀÔ·ÂÇß´ÂÁö, ¶Ç´Â ºñ¾îÀÖ´ÂÁö È®ÀÎ ===
   if UserNameInput = '' then
   begin
      ShowMessage('»ç¿ëÇÒ ÀÌ¸§À» ÀÔ·ÂÇØÁÖ¼¼¿ä. ÀÌ¸§Àº °ø¹é¸¸À¸·Î ±¸¼ºµÉ ¼ö ¾ø½À´Ï´Ù.');
      editName.SetFocus; // Æ÷Ä¿½º ÀÌµ¿
      Exit;
   end;

  // === 2. ÀÌ¸§ Áß°£¿¡ ½ºÆäÀÌ½º¹Ù(°ø¹é)°¡ ÀÖ´ÂÁö È®ÀÎ ===
      if Pos(' ', UserNameInput) > 0 then
      begin
         ShowMessage('ÀÌ¸§ Áß°£¿¡ °ø¹éÀ» Æ÷ÇÔÇÒ ¼ö ¾ø½À´Ï´Ù. ´Ù½Ã ÀÔ·ÂÇØÁÖ¼¼¿ä.');
         editName.SetFocus;
      Exit;
      end;

   // === 3. Æ¯¼ö¹®ÀÚ Æ÷ÇÔ ¿©ºÎ È®ÀÎ ===
   // ÀÏ¹İ¹®ÀÚ ÀÌ¿ÜÀÇ ¹®ÀÚ°¡ Æ÷ÇÔµÇ¾ú´ÂÁö È®ÀÎ
   if Not TRegEx.IsMatch(UserNameInput, '^[°¡-ÆRa-zA-Z0-9]+$') then
   begin
      ShowMessage('ÀÌ¸§¿¡´Â ÇÑ±Û, ¿µ¹®, ¼ıÀÚ¸¸ »ç¿ëÇÒ ¼ö ÀÖ½À´Ï´Ù. Æ¯¼ö¹®ÀÚ¸¦ Á¦°ÅÇØÁÖ¼¼¿ä.');
      editName.SetFocus;
      Exit;
      end;

  // === 4. ÃÖÁ¾ ±ÛÀÚ ¼ö È®ÀÎ (ÇÑ±Û 8ÀÚ, ¿µ¹® 8ÀÚ ±âÁØ) ===
   if (Length(UserNameInput) > 8) and (Not TRegEx.IsMatch(UserNameInput, '^[a-zA-Z0-9]+$')) then
//   if Length(UserNameInput) > 8 then
   begin
      ShowMessage('ÀÌ¸§Àº ÃÖ´ë 8ÀÚ±îÁö °¡´ÉÇÕ´Ï´Ù. (ÇöÀç: ' + IntToStr(Length(UserNameInput)) + 'ÀÚ)');
      editName.SetFocus;
      Exit;
   end;

   // === 5. Áßº¹ °Ë»ç (¼­¹ö¿ÍÀÇ Åë½Å ÇÊ¿ä) ÈÄ  À¯Àúµî·Ï¿Ï·á===
   //++¼­¹ö¿¡ ÀÖ´Â À¯Àú ÀÌ¸§ ¸®½ºÆ®¸¦ °Ë»öÇØ¼­ ºñ±³ (¼öÁ¤ ÇÊ¿ä)

   SendChatStringDirectly;  //ÀÌ¸§ ¼­¹ö¿¡ Àü¼ÛÇÏ´Â ÇÁ·Î½ÃÀú

   // === 6. MainÆûÀ¸·Î º¯È¯===


end;

{
°ø¹é ¹®ÀÚ¿­ Æ¯¼ö¹®ÀÚ ¿¹¿Ü Ã³¸®ÈÄ À¯Àú ÀÌ¸§À» ½ºÆ®¸²¿¡ ¿Ã·Á¼­ Àü¼Û
=> ¼­¹ö¿¡¼­ Áßº¹µÈ ÀÌ¸§ °Ë»çÈÄ Å¬¶óÀÌ¾ğÆ®¿¡ Àü¼Û
}
procedure TRegisterUserForm.SendChatStringDirectly;
var
   NameStringStream: TStringStream;
   NameText: String;
   ServerResponse: String;
   LClient : TIdTCPClient;

begin
   LClient := Connect.ConnectForm.IdTCPClient;

   if not Assigned(LClient) then
   begin
      ShowMessage('³×Æ®¿öÅ© Å¬¶óÀÌ¾ğÆ® °´Ã¼°¡ À¯È¿ÇÏÁö ¾Ê½À´Ï´Ù.');
      Exit; //ÇÁ·Î½ÃÀú Á¾·á
   end;

   // Å¬¶óÀÌ¾ğÆ® °´Ã¼ ÇÒ´ç ¹× ¼­¹ö ¿¬°á »óÅÂ È®ÀÎ
   if not LClient.Connected then
   begin
      ShowMessage('¼­¹öÀÇ ¿¬°áµÇ¾î ÀÖÁö ¾Ê½À´Ï´Ù.');
      Exit;
   end;

   //9/3  IOHandlerÀÇ ±âº» ÀÎÄÚµùÀ» UTF-8·Î ¼³Á¤
   LClient.IOHandler.DefStringEncoding := IndyTextEncoding_UTF8;

   NameText := editName.Text;

   // 1. TStringStream »ı¼º ¹× ¹®ÀÚ¿­ ÀúÀå
     NameStringStream := TStringStream.Create(NameText, TEncoding.UTF8);
   try
      try
         //Àü¼Û
         LClient.IOHandler.WriteLn(NameStringStream.DataString);
         //ÀÀ´ä ´ë±â
         ServerResponse := Lclient.IOHandler.ReadLn;

         if ServerResponse.StartsWith('ERROR|NAME_EXISTS|') then
         begin
            ShowMessage('Áßº¹µÈ ÀÌ¸§ÀÔ´Ï´Ù. ´Ù½Ã ÀÌ¸§À» ÀÔ·ÂÇØ ÁÖ¼¼¿ä.');
            editName.SetFocus;
            Self.ModalResult := mrNone;
            Exit;
         end
         else
         begin
            ShowMessage('ÀÌ¸§ [' + NameText + ']À¸·Î ¼º°øÀûÀ¸·Î µî·ÏµÇ¾ú½À´Ï´Ù!');
            Self.ModalResult := mrOK;

            Hide;  // ÇöÀç Æû ¼û±â±â
            FormMain.Show;     // À¯Àú µî·Ï ÆûÀ¸·Î ÀÌµ¿
         end;

      except
         on E: Exception do
         begin
            ShowMessage('³×Æ®¿öÅ© Åë½Å Áß ¿À·ù ¹ß»ı: ' + E.Message);
            Self.ModalResult := mrNone;
         end;
      end;
   finally
      NameStringStream.Free;

   end;
end;

end.

