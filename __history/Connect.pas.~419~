unit Connect;
{
-FormCreate 프로시저
폼 생성 시 통신 객체(Con) 를 만들고 서버에 접속하며, 서버 응답을 받을 이벤트 핸들러를 미리 구독

-btnLoginClick 프로시저
사용자가 입력한 ID/PW를 서버에 'LOGIN' 명령으로 전송하는 역할.

-btnSignUpClick 프로시저
SignUpForm폼을 화면에 띄워주는 역할.

-HandleLoginResponse 프로시저
'LOGIN' 명령에 대한 서버의 응답을 받아 처리하는 함수, 성공 시 메인폼 전환

-HandleSignUpResponse 프로시저
'SignUpForm'에서 보낸 'SIGNUP' 요청에 대한 서버의 응답을 최종적으로 받아 처리하는 함수.

-코드흐름
   -로그인
   1. 프로그램 시작 → TConnectForm.FormCreate() 실행
   2. Con 객체 생성 및 서버 연결, OnLoginResponse 이벤트에 HandleLoginResponse를 연결.
   3. 사용자가 ID/PW 입력 후 로그인 버튼 클릭 → btnLoginClick() 호출
   4. Con.SendJson("LOGIN", [...]) → 서버로 로그인 정보 전송
   5. 서버 → 로그인 결과 JSON 전송 )
   6. Data 유닛의 수신 스레드가 응답을 감지 → OnLoginResponse 이벤트 실행
   7. ConnectForm.HandleLoginResponse() → "OK" 상태 확인, UserInfo에 이름 저장 후 폼을 닫고 MainForm으로 전환.
   -회원가입

   1. ConnectForm에서 '회원가입' 버튼을 클릭.
   2. SignUpForm을 생성하여 화면에 모달(Modal) 형태로 생성.
   3. SignUpForm에 이름, ID, PW를 입력하고 '가입 요청' 버튼을 클릭.
   4. SignUpForm에 입력된 정보를 SIGNUP 명령과 함께 JSON으로 만들어 서버에 전송.
   5. 서버에서 ID 중복 등을 확인하고, 결과를 JSON으로 클라이언트에 응답.
   6. 서버의 응답을 수신하고 OnSignUpResponse 이벤트를 실행.
   7. SignUpForm이 아닌 ConnectForm이 이 신호를 받고 status가 "OK"이면 "회원가입 성공" 메시지를 보여주고 SignUpForm을 닫기.
}
interface

uses
   Winapi.Windows, Winapi.Messages, System.SysUtils, System.Classes,
   Vcl.Graphics, Vcl.Controls, Vcl.Forms, Vcl.Dialogs, Vcl.StdCtrls,
   IdTCPClient, Vcl.ExtCtrls, Data, Data.DBXJSON;

type

   TConnectForm = class(TForm)
      UserId         : TEdit;
      UserPassword   : TEdit;
      btnLogin       : TButton;
      Panel1         : TPanel;
      Panel2         : TPanel;
      Panel3         : TPanel;
      labelIP        : TLabel;
      labelPort      : TLabel;

      procedure FormCreate       (Sender: TObject);
      procedure btnLoginClick    (Sender: TObject);
      procedure FormShow         (Sender: TObject);
      procedure FormDestroy      (Sender: TObject);

   private
      RecvThread: TReceiveThread;

   public
      procedure HandleLoginResponse (Sender: TObject; const Msg: string);
   end;

var
   ConnectForm: TConnectForm;

implementation

{$R *.dfm}

uses Main, UserInfo, IdException;

//=========
procedure TConnectForm.FormCreate(Sender: TObject);
begin
   if not Assigned(Con) then
      Con := TCon.Create;    //중앙처리장치를  할당 시켜준 후

   Con.ConnectToServer;      //서버와 연결

   // 로그인 이벤트 구독
   Con.OnLoginResponse     := HandleLoginResponse;

end;


procedure TConnectForm.FormDestroy(Sender: TObject);
begin
  // 폼이 완전히 닫힐 때
  if Assigned(Con) then
  begin
    // 이벤트 핸들러 연결 해제
    Con.OnLoginResponse := nil;

    // 연결되어 있다면 연결 해제
    if Con.Client.Connected then
      Con.Client.Disconnect;

    // 객체 파괴
    Con.Free;
    Con := nil;
  end;
end;

procedure TConnectForm.FormShow(Sender: TObject);
var
   bIsConnected: Boolean;
begin
   bIsConnected := False;
   try
      //  여기서 EIdClosedSocket 예외가 발생
      if Assigned(Con) then
         bIsConnected := Con.Client.Connected;
   except
      // 예외를 잡아서 bIsConnected = False
      on E: Exception do
      begin
         // 의도된 로그아웃
      end;
   end;

   //  bIsConnected가 False이므로
   if not bIsConnected then
   begin
      //  다시 연결을 시도합니다.
      Con.ConnectToServer;
   end;
end;

//====로그인 버튼 클릭시====//
procedure TConnectForm.btnLoginClick(Sender: TObject);
begin
   if Assigned(Con) and Con.Client.Connected then         //Con 이 할당되고 서버와 연결 되었으면
      Con.SendJson('LOGIN', ['id', UserId.Text, 'pw', UserPassword.Text]);           //LOGIN 명령어 과 그에 필요한 데이터 서버로 전송
end;


//=======로그인 응답 처리====//
procedure TConnectForm.HandleLoginResponse(Sender: TObject; const Msg: string);
var
   JSONObject                    : TJSONObject;
   Status, MsgText, Cmd, UserName: string;
   LMainForm                     : TMainForm;
begin
   JSONObject := TJSONObject.ParseJSONValue(Msg) as TJSONObject;        //서버로 부터 받은 Msg를 객체로 변환후 저장
   try
      if JSONObject <> nil then
      begin
         Status      := SafeGetValue(JSONObject, 'status');             //각 키에 맞는 값을 저장
         MsgText     := SafeGetValue(JSONObject, 'message');
         Cmd         := SafeGetValue(JSONObject, 'command');

         // command 가 LOGIN 일 때만 처리
         if SameText(Cmd, 'Login') then
         begin
            if SameText(Status, 'OK') then
            begin
            // 로그인 성공 처리
               UserName := SafeGetValue(JSONObject, 'username'); // 서버가 보내준 이름

               ShowMessage('로그인 성공! 사용자 이름: ' + UserName);

               UserInfo.CurrentUserName   := UserName;            //UserInfo에 본인 이름 저장
//               ModalResult                := mrOK; // 로그인 성공 → 폼 닫기 가능

               Self.Hide;
               LMainForm := TMainForm.Create(Application);

               LMainForm.Show;
            end
            else
            begin
               ShowMessage('Login failed: ' + MsgText);
               OutputDebugString(PChar('Login failed: ' + MsgText));
            end;
         end
         else
         begin
            OutputDebugString(PChar('Ignored non-LOGIN response: ' + Cmd));
         end;
      end;
   finally
      JSONObject.Free;
   end;
end;


end.
